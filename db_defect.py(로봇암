#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import base64
import mysql.connector

# ğŸ”¹ ìœˆë„ìš° MySQL ì„œë²„ ì •ë³´
DB_HOST = "172.30.1.96"   # ë„¤ ìœˆë„ìš° PC IP
DB_USER = "rosuser"       # ì´ë¯¸ ë§Œë“  ê³„ì •
DB_PASSWORD = "1234"
DB_NAME = "dbdb"


def insert_defect_image_from_path(img_path: str) -> None:
    """
    ì €ì¥ëœ ë¶ˆëŸ‰ ì´ë¯¸ì§€ íŒŒì¼(jpg)ì„ ì½ì–´ì„œ
    base64 ë¬¸ìì—´ë¡œ ë³€í™˜í•œ ë’¤ defect_logì— INSERT í•œë‹¤.
    """

    # 1) íŒŒì¼ ì¡´ì¬ í™•ì¸
    if not os.path.exists(img_path):
        print(f"[db_defect] íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: {img_path}")
        return

    try:
        # 2) íŒŒì¼ â†’ ë°”ì´íŠ¸
        with open(img_path, "rb") as f:
            img_bytes = f.read()

        # 3) ë°”ì´íŠ¸ â†’ base64 ë¬¸ìì—´
        img_b64 = base64.b64encode(img_bytes).decode("utf-8")

        # 4) MySQL ì ‘ì†
        conn = mysql.connector.connect(
            host=DB_HOST,
            user=DB_USER,
            password=DB_PASSWORD,
            database=DB_NAME,
        )
        cursor = conn.cursor()

        # 5) INSERT (timestampëŠ” DEFAULT CURRENT_TIMESTAMP)
        sql = """
            INSERT INTO defect_log (image_base64)
            VALUES (%s)
        """
        cursor.execute(sql, (img_b64,))
        conn.commit()

        print(f"[db_defect] INSERT defect_log OK ({img_path})")

    except Exception as e:
        print("[db_defect] DB INSERT ì‹¤íŒ¨:", e)

    finally:
        # 6) ì •ë¦¬
        try:
            cursor.close()
            conn.close()
        except:
            pass
