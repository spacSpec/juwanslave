#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import serial
import threading
import time
import mysql.connector  # ğŸ”¥ DB ì‚¬ìš©

# ==========================================
# ìŠ¬ë ˆì´ë¸Œ PC ê¸°ë³¸ ì„¤ì •
# ==========================================
PORT = "/dev/ttyUSB0"   # (ìœˆë„ìš°ë©´ "COM3" ë“±ìœ¼ë¡œ ë³€ê²½)
BAUD = 9600
SLAVE_ID = 3

# ==========================================
# BIT / WORD ì£¼ì†Œ ë§¤í•‘
# ==========================================
COIL_M0_ADDR  = 0x0000    # M0  â†’ ì•ˆì „íœìŠ¤ ON/OFF
COIL_M4_ADDR  = 0x0004    # M4  â†’ ì¶”ê°€ ì‹ í˜¸ ON/OFF
COIL_M70_ADDR = 0x0070    # M70 â†’ ì»¨ë² ì´ì–´ ON/OFF

REG_D2_ADDR   = 0x0011    # D00002 (WORD, Modbus: 0x40011) â†’ ì¬ê³  ìˆ˜ëŸ‰
REG_D100_ADDR = 0x0020    # D100   (WORD, Modbus: 0x40020) â†’ ì£¼íŒŒìˆ˜
REG_D500_ADDR = 0x0021    # D500   (WORD, Modbus: 0x40021) â†’ ì „ë¥˜

# ==========================================
# ë©”ëª¨ë¦¬ ê³µê°„
# ==========================================
coils = [0] * 1024          # BIT (í•„ìš”í•œ ë§Œí¼ ë„‰ë„‰íˆ)
holding_regs = [0] * 65536  # WORD

# ==========================================
# ğŸ”¥ MySQL ì„¤ì • (DB ì„œë²„: 172.30.1.96)
# ==========================================
DB_HOST = "172.30.1.96"
DB_USER = "rosuser"
DB_PASSWORD = "1234"
DB_NAME = "dbdb"


def insert_plc_to_db(m0, m4, m70, d2_stock, d100, d500):
    """
    PLCì—ì„œ ë°›ì€ M0/M4/M70/D00002/D100/D500 ê°’ì„
    plc_conveyor_log í…Œì´ë¸”ì— INSERT

    - m0       : 0 ë˜ëŠ” 1 (ì•ˆì „íœìŠ¤)
    - m4       : 0 ë˜ëŠ” 1 (ì…”í„° ë“± ì¶”ê°€ ì‹ í˜¸)
    - m70      : 0 ë˜ëŠ” 1 (ì»¨ë² ì´ì–´ RUN)
    - d2_stock : ì¬ê³  ìˆ˜ëŸ‰ (D00002)
    - d100     : ì£¼íŒŒìˆ˜ ì›ì‹œ ê°’
    - d500     : ì „ë¥˜ ì›ì‹œ ê°’
    """

    # í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ ìŠ¤ì¼€ì¼ ì¡°ì • (ì˜ˆ: /10.0, /100.0 ë“±)
    m0_state      = int(m0)
    m4_state      = int(m4)
    running       = int(m70)
    stock_qty     = int(d2_stock)      # ì¬ê³  ìˆ˜ëŸ‰
    frequency     = float(d100)
    motor_current = float(d500)

    try:
        conn = mysql.connector.connect(
            host=DB_HOST,
            user=DB_USER,
            password=DB_PASSWORD,
            database=DB_NAME,
        )
        cursor = conn.cursor()

        # â˜… stock_qty ì»¬ëŸ¼ê¹Œì§€ í•¨ê»˜ INSERT
        sql = """
            INSERT INTO plc_conveyor_log
                (running, m0_state, m4_state, stock_qty, frequency, motor_current)
            VALUES (%s, %s, %s, %s, %s, %s)
        """
        cursor.execute(
            sql,
            (running, m0_state, m4_state, stock_qty, frequency, motor_current),
        )
        conn.commit()

        print(
            f"[DB] INSERT plc_conveyor_log OK  "
            f"(M0={m0_state}, M4={m4_state}, RUN={running}, "
            f"STOCK={stock_qty}, FREQ={frequency}, CUR={motor_current})"
        )

    except Exception as e:
        print(f"[DB ERROR] PLC INSERT ì‹¤íŒ¨: {e}")

    finally:
        try:
            cursor.close()
            conn.close()
        except:
            pass


# ==========================================
# CRC16 (Modbus RTU)
# ==========================================
def crc16(data: bytes) -> bytes:
    crc = 0xFFFF
    for b in data:
        crc ^= b
        for _ in range(8):
            if crc & 1:
                crc = (crc >> 1) ^ 0xA001
            else:
                crc >>= 1
    return bytes([crc & 0xFF, (crc >> 8) & 0xFF])


# ==========================================
# ìš”ì²­ ì²˜ë¦¬ í•¨ìˆ˜
# ==========================================
def handle_request(frame: bytes, ser: serial.Serial):
    if len(frame) < 8:
        return

    slave = frame[0]
    func = frame[1]

    # ìŠ¬ë ˆì´ë¸Œ ID ì²´í¬
    if slave != SLAVE_ID:
        return

    # CRC ì²´í¬
    recv_crc = frame[-2] | (frame[-1] << 8)
    calc_crc = int.from_bytes(crc16(frame[:-2]), "little")
    if recv_crc != calc_crc:
        # CRC ì•ˆ ë§ìœ¼ë©´ ë¬´ì‹œ
        return

    # ì£¼ì†Œ íŒŒì‹±
    addr = (frame[2] << 8) | frame[3]

    # ----------------------------------------------------------
    # 0x05 - WRITE SINGLE COIL (PLC â†’ PC)
    # ----------------------------------------------------------
    if func == 0x05:
        value = frame[4] == 0xFF
        coils[addr] = 1 if value else 0

        # ì—ì½” ì‘ë‹µ
        resp = frame[:-2]
        resp += crc16(resp)
        ser.write(resp)

        print(f"[PLCâ†’PC BIT] WRITE addr={addr:#06x}, value={coils[addr]}")

    # ----------------------------------------------------------
    # 0x01 - READ COILS (PC â†’ PLC)
    # ----------------------------------------------------------
    elif func == 0x01:
        count = (frame[4] << 8) | frame[5]
        byte_val = 0
        for i in range(count):
            if coils[addr + i]:
                byte_val |= 1 << i

        resp = bytes(
            [
                SLAVE_ID,
                0x01,
                0x01,  # ë°”ì´íŠ¸ ìˆ˜ (ì§€ê¸ˆì€ 1ë°”ì´íŠ¸ë§Œ ì „ì†¡)
                byte_val,
            ]
        )
        resp += crc16(resp)
        ser.write(resp)

        print(f"[PCâ†’PLC BIT] READ addr={addr:#06x}, send={byte_val:#04x}")

    # ----------------------------------------------------------
    # 0x06 - WRITE SINGLE REGISTER (PLC â†’ PC)
    # ----------------------------------------------------------
    elif func == 0x06:
        value = (frame[4] << 8) | frame[5]
        holding_regs[addr] = value

        resp = frame[:-2]
        resp += crc16(resp)
        ser.write(resp)

        print(f"[PLCâ†’PC WORD] WRITE REG addr={addr:#06x}, value={value}")


# ==========================================
# ì‹œë¦¬ì–¼ ìˆ˜ì‹  ìŠ¤ë ˆë“œ
# ==========================================
def serial_loop(ser: serial.Serial):
    buf = bytearray()

    while True:
        if ser.in_waiting:
            buf += ser.read(ser.in_waiting)

            # ëª¨ë“œë²„ìŠ¤ í”„ë ˆì„ ìµœì†Œ 8ë°”ì´íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ì˜ë¼ì„œ ì²˜ë¦¬
            while len(buf) >= 8:
                frame = bytes(buf[:8])
                buf = buf[8:]
                handle_request(frame, ser)

        time.sleep(0.01)


# ==========================================
# ëª¨ë‹ˆí„°ë§ ìŠ¤ë ˆë“œ (M0, M4, M70, D2, D100, D500)
# ==========================================
def monitor_loop():
    prev_m0 = None
    prev_m4 = None
    prev_m70 = None
    prev_d2 = None
    prev_d100 = None
    prev_d500 = None

    while True:
        m0   = coils[COIL_M0_ADDR]          # ì•ˆì „íœìŠ¤
        m4   = coils[COIL_M4_ADDR]          # ì…”í„°/ì¶”ê°€ ì‹ í˜¸
        m70  = coils[COIL_M70_ADDR]         # ì»¨ë² ì´ì–´ RUN
        d2   = holding_regs[REG_D2_ADDR]    # ì¬ê³  ìˆ˜ëŸ‰ (D00002)
        d100 = holding_regs[REG_D100_ADDR]  # ì£¼íŒŒìˆ˜
        d500 = holding_regs[REG_D500_ADDR]  # ì „ë¥˜

        # ê°’ì´ ë°”ë€” ë•Œë§Œ ì¶œë ¥ + DB ì¸ì„œíŠ¸
        if (m0, m4, m70, d2, d100, d500) != (
            prev_m0,
            prev_m4,
            prev_m70,
            prev_d2,
            prev_d100,
            prev_d500,
        ):
            print(
                f"[MONITOR] M0={m0}, M4={m4}, M70={m70}, "
                f"D2={d2}, D100={d100}, D500={d500}"
            )
            prev_m0, prev_m4, prev_m70 = m0, m4, m70
            prev_d2, prev_d100, prev_d500 = d2, d100, d500

            # ğŸ”¥ DBì— í•œ ì¤„ INSERT
            insert_plc_to_db(m0, m4, m70, d2, d100, d500)

        time.sleep(0.1)  # 100msë§ˆë‹¤ ì²´í¬


# ==========================================
# ë©”ì¸ ì‹¤í–‰ë¶€
# ==========================================
def main():
    ser = serial.Serial(
        PORT,
        BAUD,
        bytesize=8,
        parity="N",
        stopbits=1,
        timeout=0.05,
    )

    print("\n===== PC Modbus Slave ì‹œì‘ =====")
    print(f"í¬íŠ¸: {PORT}, ì†ë„: {BAUD}, ìŠ¬ë ˆì´ë¸ŒID: {SLAVE_ID}")
    print(f"DB: host={DB_HOST}, user={DB_USER}, db={DB_NAME}\n")

    # Modbus ìˆ˜ì‹  ìŠ¤ë ˆë“œ
    threading.Thread(target=serial_loop, args=(ser,), daemon=True).start()

    # ëª¨ë‹ˆí„°ë§ ìŠ¤ë ˆë“œ
    threading.Thread(target=monitor_loop, daemon=True).start()

    # ë©”ì¸ ìŠ¤ë ˆë“œëŠ” ê·¸ëƒ¥ ëŒ€ê¸°ìš©
    try:
        while True:
            time.sleep(1.0)
    except KeyboardInterrupt:
        print("\nì¢…ë£Œ ìš”ì²­ë¨(CTRL+C)")
    finally:
        ser.close()
        print("ì‹œë¦¬ì–¼ í¬íŠ¸ ë‹«ìŒ, í”„ë¡œê·¸ë¨ ì¢…ë£Œ")


if __name__ == "__main__":
    main()
